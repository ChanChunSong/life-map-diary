<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Map & Daily Log</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen flex flex-col items-center p-4 bg-gray-50">
    <!-- Header - Now spans wider for the two-column view -->
    <header class="w-full max-w-3xl md:max-w-6xl bg-blue-700 text-white p-6 rounded-t-xl shadow-xl text-center">
        <h1 class="text-3xl font-extrabold mb-1">Daily Log & Life Map</h1>
        
        <!-- Editable Date and Count Inputs -->
        <div class="flex flex-wrap justify-center space-x-2 space-y-2 sm:space-y-0 text-sm mt-3">
            
            <!-- Date Input with Native Picker and Dynamic Weekday -->
            <div class="flex items-center space-x-1">
                <span class="font-medium">Date:</span>
                <input type="date" id="date-input" class="p-1 w-32 text-sm text-gray-800 rounded focus:ring-blue-300 focus:border-blue-300 border-none">
                <span id="weekday-display" class="text-sm font-semibold w-20"></span>
            </div>
            
            <!-- Consecutive Day Input with Custom Buttons -->
            <div class="flex items-center space-x-1">
                <span class="font-medium">Day:</span>
                <div class="flex items-stretch rounded overflow-hidden">
                    <button onclick="changeCount('consecutive-day-input', -1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-l-md">-</button>
                    <input type="number" id="consecutive-day-input" placeholder="32" class="p-1 w-12 text-sm text-gray-800 text-center count-input border-y border-gray-300 focus:ring-0 focus:border-gray-300">
                    <button onclick="changeCount('consecutive-day-input', 1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-r-md">+</button>
                </div>
            </div>

            <!-- Accumulated Count Input with Custom Buttons -->
            <div class="flex items-center space-x-1">
                <span class="font-medium">Count:</span>
                <div class="flex items-stretch rounded overflow-hidden">
                    <button onclick="changeCount('accumulated-count-input', -1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-l-md">-</button>
                    <input type="number" id="accumulated-count-input" placeholder="55" class="p-1 w-12 text-sm text-gray-800 text-center count-input border-y border-gray-300 focus:ring-0 focus:border-gray-300">
                    <button onclick="changeCount('accumulated-count-input', 1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-r-md">+</button>
                </div>
            </div>
        </div>

        <!-- Authentication Area -->
        <div class="mt-4 border-t border-blue-600 pt-3 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
            <p id="auth-status-display" class="text-sm font-medium">Authenticating...</p>
            <button id="auth-button" onclick="signInWithGoogle()" class="px-4 py-2 bg-white text-blue-700 rounded-lg font-bold hover:bg-gray-100 transition duration-150 shadow-md disabled:opacity-50" disabled>
                Sign in with Google
            </button>
        </div>
    </header>

    <!-- Status Message -->
    <div id="status-message" class="w-full max-w-3xl md:max-w-6xl p-3 text-center text-sm font-semibold rounded-t-none bg-yellow-100 text-yellow-800 hidden">
        Connecting to storage...
    </div>

    <!-- HISTORY SECTION (New position, Full-width band below header/status) -->
    <section id="history-section" class="w-full max-w-3xl md:max-w-6xl mx-auto p-5 rounded-b-xl border border-blue-200 bg-white shadow-xl mb-6">
        <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-300 pb-2 mb-4">ğŸ•°ï¸ Past Entries History</h2>
        
        <!-- DROPDOWN SELECT BOX -->
        <select id="history-dropdown" onchange="handleHistorySelect()">
            <option value="" disabled selected>Select a past entry...</option>
        </select>

        <!-- Status message specifically for the history loading -->
        <p id="history-status" class="text-gray-500 italic mt-2">Sign in to load history...</p>
        
    </section>

    <!-- Floating Navigation Menu -->
    <nav id="floating-nav" class="hidden fixed left-4 top-1/2 -translate-y-1/2 bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-200">
        <ul class="space-y-2">
            <li><a href="#history-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">History</a></li>
            <li><a href="#reflection-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Reflection</a></li>
            <li><a href="#lifemap-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Life Map</a></li>
            <li><a href="#worklog-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Work Log</a></li>
            <li><a href="#weekgoals-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Week Goals</a></li>
            <li><a href="#gamification-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Gamification</a></li>
            <li><a href="#longterm-plan-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Long Term</a></li>
            <li><a href="#shortterm-plan-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Short Term</a></li>
            <li><a href="#english-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">English</a></li>
            <li><a href="#japanese-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Japanese</a></li>
            <li><a href="#custom-notes-section" class="nav-link text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">Custom</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT WRAPPER -->
    <div class="w-full max-w-3xl md:max-w-6xl mx-auto">
        
        <!-- MAIN CONTENT: Form and Output (Full Width of wrapper) -->
        <main class="w-full p-6 bg-white shadow-xl rounded-xl mb-8">
            
            <!-- Section 1: Story, Emotion, Gratitude, Reflection -->
            <section id="reflection-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">âœ¨ Story, Emotion, Gratitude, Reflection</h2>
                <textarea id="reflection-entry" rows="16" placeholder="How was your day? What did you feel? What are you grateful for?"
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
                <div id="reflection-word-count" class="text-sm text-gray-500 mt-2 text-right">Words: 0</div>
            </section>

            <!-- Section 2: Life Map (Daily Architecture) -->
            <section id="lifemap-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-2">ğŸ—ºï¸ Life Map (Daily Architecture)</h2>
                <p class="text-sm italic text-gray-500 mb-4">Log daily adherence and notes based on your routine.</p>
                <textarea id="life-map-log" rows="30" 
                          class="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono-custom resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                          placeholder="e.g., 06:40 - Morning Prep: Successful. 13:00 - Exercise: Jogged 30 mins.">
Time    Activity    Detail
06:40   Morning Prep
07:25   School Commute
08:30   Office Commute (Eng Practice/Finance)
09:30   Meditation
09:45   Breakfast
10:00   Work/Learning
12:00   Lunch/Rest
13:00   Exercise/Rest
14:00   Work Focus
16:30   End Day
18:30   Dinner
19:00   Older Daughter's Learning
19:50   Bathing
20:00   Bedtime Prep
20:30   Younger Daughter's Bedtime
21:30   Co-Sleeping
22:00   Laptop Setup
23:00   Evening Work
00:00   Exercise (Squat)
</textarea>
            </section>

            <!-- Section 3: Work Log - NOW DYNAMIC LIST -->
            <section id="worklog-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">
                    ğŸ’¼ Work Log (Dynamic Tasks)
                    <button id="toggle-all-details-button" class="text-sm text-blue-500 hover:text-blue-700 transition duration-150 ease-in-out ml-4">Collapse/Expand All</button>
                </h2>
                
                <!-- Container for dynamic task rows -->
                <div id="work-items-container" class="space-y-4 mb-4">
                </div>

                <button onclick="addWorkItem()" class="w-full py-2 px-4 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition duration-150 ease-in-out">
                    + Add Work Item
                </button>

                <!-- Container for COMPLETED tasks (Solution 2: Collapsible Accordion) -->
                <div id="completed-tasks-section" class="mt-6">
                    <details class="group bg-gray-50 border border-gray-200 rounded-lg open:shadow-md transition-all duration-200">
                        <summary class="list-none flex items-center justify-between cursor-pointer p-4 font-semibold text-gray-700 hover:text-blue-600 hover:bg-gray-100 rounded-lg">
                            <span class="flex items-center gap-2">
                                âœ… Completed Tasks <span id="completed-tasks-summary-count" class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">0 items</span>
                            </span>
                            <span class="transition group-open:rotate-180">
                                <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                            </span>
                        </summary>
                        
                        <div class="border-t border-gray-200 p-2">
                            <div id="completed-work-items-container" class="space-y-1 opacity-75">
                                <!-- Completed items will be moved here by script.js -->
                            </div>
                        </div>
                    </details>
                </div>
            </section>
            
            <!-- Section 4: WEEK GOALS -->
            <section id="weekgoals-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 id="week-goals-header" class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">ğŸ¯ Week Goals</h2>
                <p class="text-sm italic text-gray-500 mb-4">W44 goals and important plans.</p>
                <textarea id="week-goals-entry" rows="16" placeholder="Update on week goals and important plans..."
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>

            <!-- SECTION 5: GAMIFICATION NOTES -->
            <section id="gamification-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">ğŸ’¡ Gamification Notes</h2>
                <p class="text-sm italic text-gray-500 mb-4">Core Drives, Octalysis ideas, or other motivational strategies.</p>
                <textarea id="gamification-notes-entry" rows="10" placeholder="Enter your gamification analysis or notes here..."
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>

            <!-- Section 6: PERSONAL LONG TERM PLAN -->
            <section id="longterm-plan-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">â³ Personal Long Term Plan</h2>
                <textarea id="long-term-plan-entry" rows="10" placeholder="e.g., Performance App, Robot App, English movies, Japanese..."
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>

            <!-- Section 7: PERSONAL SHORT TERM PLAN -->
            <section id="shortterm-plan-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">ğŸš€ Personal Short Term Plan</h2>
                <textarea id="short-term-plan-entry" rows="6" placeholder="e.g., Set gamification for Cecilia..."
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>
            
            <!-- Section 8: ENGLISH PRACTICE -->
            <section id="english-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">ğŸ‡¬ğŸ‡§ English Practice</h2>
                <textarea id="english-practice-entry" rows="6" placeholder="Log today's English learning activity and notes..."
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>

            <!-- Section 9: JAPANESE PRACTICE -->
            <section id="japanese-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">ğŸ‡¯ğŸ‡µ Japanese Practice</h2>
                <textarea id="japanese-practice-entry" rows="6" placeholder="Log today's Japanese learning, e.g., vocabulary, grammar, lyrics..."
                          class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>

            <!-- Section 10: CUSTOM END NOTES (User-defined title) -->
            <section id="custom-notes-section" class="p-5 rounded-xl border border-gray-100 mb-6">
                <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">ğŸ“ Custom Daily Notes Header</h2>
                <!-- Input for the user-defined Markdown Title -->
                <input type="text" id="custom-notes-title" placeholder="Enter the header title for the final entry (e.g., Final Checklist or New Ideas)"
                       class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                <p class="text-sm italic text-gray-500 mb-4">Enter the content for this custom section below.</p>
                <textarea id="custom-notes-entry" rows="10" placeholder="Enter notes here..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </section>

            <!-- Save Button now calls saveDiaryEntry -->
            <button id="save-button" onclick="saveDiaryEntry()" class="w-full py-4 bg-green-600 text-white font-bold text-lg rounded-xl transition-colors shadow-lg hover:bg-green-700 disabled:opacity-50" disabled>
                ğŸ’¾ Generate, Save & Copy Entry
            </button>
            
            <!-- Log Output -->
            <section id="output-section" class="mt-6">
                <h2 class="text-xl text-gray-800 font-semibold border-b border-gray-200 pb-2 mb-4">ğŸ“ Generated Entry (Copy/Paste)</h2>
                <textarea id="diary-output" rows="30" readonly 
                          class="w-full p-4 bg-gray-100 border-2 border-dashed border-gray-400 rounded-lg text-sm font-mono-custom resize-y" 
                          placeholder="Your formatted entry will appear here after you click 'Generate & Copy Entry'."></textarea>
            </section>
        </main>
    </div>

    <footer class="text-sm text-gray-500 mt-4 pb-8">
        <p>Built for the Life Map Logger &copy; 2025</p>
    </footer>

    <script src="firebase_secrets.js"></script>
    <script type="module" src="script.js"></script>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button class="fab-main" id="fab-main-button">
            <span>+</span>
        </button>
        <div class="fab-menu">
            <button class="fab-item" id="fab-next-day-button" title="Next Day & Count (+1) [Alt+Right]">
                âœ¨
            </button>
            <button class="fab-item" id="fab-save-button" title="Save Diary [Ctrl+S]">
                ğŸ’¾
            </button>
            <button class="fab-item" id="fab-copy-button" title="Copy Output">
                ğŸ“‹
            </button>
        </div>
    </div>

    <!-- Bottom Navigation Bar for Mobile -->
    <nav id="bottom-nav" class="hidden fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-sm shadow-t-lg border-t border-gray-200">
        <ul class="flex justify-around overflow-x-auto">
            <li><a href="#history-section" class="nav-link-bottom p-2 flex flex-col items-center text-xs font-medium text-gray-600 hover:text-blue-600 transition-colors"><span class="text-xl">ğŸ•°ï¸</span><span class="nav-text">History</span></a></li>
            <li><a href="#reflection-section" class="nav-link-bottom p-2 flex flex-col items-center text-xs font-medium text-gray-600 hover:text-blue-600 transition-colors"><span class="text-xl">âœ¨</span><span class="nav-text">Reflection</span></a></li>
            <li><a href="#lifemap-section" class="nav-link-bottom p-2 flex flex-col items-center text-xs font-medium text-gray-600 hover:text-blue-600 transition-colors"><span class="text-xl">ğŸ—ºï¸</span><span class="nav-text">Life Map</span></a></li>
            <li><a href="#worklog-section" class="nav-link-bottom p-2 flex flex-col items-center text-xs font-medium text-gray-600 hover:text-blue-600 transition-colors"><span class="text-xl">ğŸ’¼</span><span class="nav-text">Work Log</span></a></li>
            <li><a href="#weekgoals-section" class="nav-link-bottom p-2 flex flex-col items-center text-xs font-medium text-gray-600 hover:text-blue-600 transition-colors"><span class="text-xl">ğŸ¯</span><span class="nav-text">Goals</span></a></li>
        </ul>
    </nav>

    <!-- Modal Dialog for Date Editing (Solution 3) -->
    <dialog id="date-modal" class="p-0 rounded-lg shadow-xl backdrop:bg-gray-900/50">
        <div class="w-80 bg-white p-6 rounded-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Adjust Task Dates</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-blue-700 mb-1">Created Time</label>
                <!-- Using type="datetime-local" for easy editing -->
                <input type="datetime-local" id="modal-created-at" class="w-full p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-green-700 mb-1">Modified Time</label>
                <input type="datetime-local" id="modal-modified-at" class="w-full p-2 border border-gray-300 rounded focus:ring-green-500 focus:border-green-500 text-sm">
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeDateModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded transition">Cancel</button>
                <button onclick="saveDateModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow">Save Changes</button>
            </div>
        </div>
    </dialog>
</body>
</html>