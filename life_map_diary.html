<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Map & Daily Log</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability of the monospace output */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-mono-custom { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        
        /* Style the inputs inside the header */
        #date-input, .count-input {
            background-color: rgba(255, 255, 255, 0.9);
            color: #1f2937; /* Dark gray text */
            transition: all 0.2s;
        }
        #date-input:focus, .count-input:focus {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); /* Indigo focus ring */
        }

        /* Hide default number input arrows for clean custom buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Styling for the non-editable weekday span */
        #weekday-display {
            background-color: white;
            padding: 4px 8px;
            border-radius: 0.25rem;
            color: #4b5563; /* Gray-700 */
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 bg-gray-50">
    <!-- Header -->
    <header class="w-full max-w-3xl bg-blue-700 text-white p-6 rounded-t-xl shadow-xl text-center">
        <h1 class="text-3xl font-extrabold mb-1">Daily Log & Life Map</h1>
        
        <!-- Editable Date and Count Inputs -->
        <div class="flex flex-wrap justify-center space-x-2 space-y-2 sm:space-y-0 text-sm mt-3">
            
            <!-- Date Input with Native Picker and Dynamic Weekday -->
            <div class="flex items-center space-x-1">
                <span class="font-medium">Date:</span>
                <input type="date" id="date-input" onchange="updateWeekday()" class="p-1 w-32 text-sm text-gray-800 rounded focus:ring-blue-300 focus:border-blue-300 border-none">
                <span id="weekday-display" class="text-sm"></span>
            </div>
            
            <!-- Consecutive Day Input with Custom Buttons -->
            <div class="flex items-center space-x-1">
                <span class="font-medium">Day:</span>
                <div class="flex items-stretch rounded overflow-hidden">
                    <button onclick="changeCount('consecutive-day-input', -1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-l-md">-</button>
                    <input type="number" id="consecutive-day-input" placeholder="32" class="p-1 w-10 text-sm text-gray-800 text-center count-input border-y border-gray-300 focus:ring-0 focus:border-gray-300">
                    <button onclick="changeCount('consecutive-day-input', 1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-r-md">+</button>
                </div>
            </div>

            <!-- Accumulated Count Input with Custom Buttons -->
            <div class="flex items-center space-x-1">
                <span class="font-medium">Count:</span>
                <div class="flex items-stretch rounded overflow-hidden">
                    <button onclick="changeCount('accumulated-count-input', -1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-l-md">-</button>
                    <input type="number" id="accumulated-count-input" placeholder="55" class="p-1 w-10 text-sm text-gray-800 text-center count-input border-y border-gray-300 focus:ring-0 focus:border-gray-300">
                    <button onclick="changeCount('accumulated-count-input', 1)" class="px-2 bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150 font-bold text-base focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-r-md">+</button>
                </div>
            </div>
        </div>

        <!-- Authentication Area -->
        <div class="mt-4 border-t border-blue-600 pt-3 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
            <p id="auth-status-display" class="text-sm font-medium">Authenticating...</p>
            <button id="auth-button" onclick="signInWithGoogle()" class="px-4 py-2 bg-white text-blue-700 rounded-lg font-bold hover:bg-gray-100 transition duration-150 shadow-md disabled:opacity-50" disabled>
                Sign in with Google
            </button>
        </div>
    </header>

    <!-- Status Message -->
    <div id="status-message" class="w-full max-w-3xl p-3 text-center text-sm font-semibold rounded-t-none bg-yellow-100 text-yellow-800 hidden">
        Connecting to storage...
    </div>

    <!-- Main Content Area -->
    <main class="w-full max-w-3xl p-6 bg-white shadow-xl rounded-b-xl mb-8">
        
        <!-- Section 1: Story, Emotion, Gratitude, Reflection -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">‚ú® Story, Emotion, Gratitude, Reflection</h2>
            <textarea id="reflection-entry" rows="8" placeholder="How was your day? What did you feel? What are you grateful for?"
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Section 2: Life Map (Daily Architecture) -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-2">üó∫Ô∏è Life Map (Daily Architecture)</h2>
            <p class="text-sm italic text-gray-500 mb-4">Log daily adherence and notes based on your routine.</p>
            <textarea id="life-map-log" rows="15" 
                      class="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono-custom resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                      placeholder="e.g., 06:40 - Morning Prep: Successful. 13:00 - Exercise: Jogged 30 mins.">
Time	Activity	Detail
06:40	Morning Prep
07:25	School Commute
08:30	Office Commute (Eng Practice/Finance)
09:30	Meditation
09:45	Breakfast
10:00	Work/Learning
12:00	Lunch/Rest
13:00	Exercise/Rest
14:00	Work Focus
16:30	End Day
18:30	Dinner
19:00	Older Daughter's Learning
19:50	Bathing
20:00	Bedtime Prep
20:30	Younger Daughter's Bedtime
21:30	Co-Sleeping
22:00	Laptop Setup
23:00	Evening Work
00:00	Exercise (Squat)
</textarea>
        </section>

        <!-- Section 3: Work Log -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üíº Work Log</h2>
            <textarea id="work-entry" rows="10" placeholder="Log today's work progress, meetings, and key issues..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Section 4: WEEK GOALS -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üéØ Week Goals (W44)</h2>
            <p class="text-sm italic text-gray-500 mb-4">W44 goals and important plans.</p>
            <textarea id="week-goals-entry" rows="8" placeholder="Update on week goals and important plans..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- SECTION 5: GAMIFICATION NOTES -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üí° Gamification Notes</h2>
            <p class="text-sm italic text-gray-500 mb-4">Core Drives, Octalysis ideas, or other motivational strategies.</p>
            <textarea id="gamification-notes-entry" rows="5" placeholder="Enter your gamification analysis or notes here..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Section 6: PERSONAL LONG TERM PLAN -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">‚è≥ Personal Long Term Plan</h2>
            <textarea id="long-term-plan-entry" rows="5" placeholder="e.g., Performance App, Robot App, English movies, Japanese..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Section 7: PERSONAL SHORT TERM PLAN -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üöÄ Personal Short Term Plan</h2>
            <textarea id="short-term-plan-entry" rows="3" placeholder="e.g., Set gamification for Cecilia..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>
        
        <!-- Section 8: ENGLISH PRACTICE -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üá¨üáß English Practice</h2>
            <textarea id="english-practice-entry" rows="3" placeholder="Log today's English learning activity and notes..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Section 9: JAPANESE PRACTICE -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üáØüáµ Japanese Practice</h2>
            <textarea id="japanese-practice-entry" rows="3" placeholder="Log today's Japanese learning, e.g., vocabulary, grammar, lyrics..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Section 10: CUSTOM END NOTES (User-defined title) -->
        <section class="p-5 rounded-xl border border-gray-100 mb-6">
            <h2 class="text-xl text-blue-700 font-semibold border-b border-blue-100 pb-2 mb-4">üìù Custom Daily Notes Header</h2>
            <!-- Input for the user-defined Markdown Title -->
            <input type="text" id="custom-notes-title" placeholder="Enter the header title for the final entry (e.g., Final Checklist or New Ideas)"
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
            <p class="text-sm italic text-gray-500 mb-4">Enter the content for this custom section below.</p>
            <textarea id="custom-notes-entry" rows="5" placeholder="Enter notes here..."
                      class="w-full p-3 border border-gray-300 rounded-lg text-base resize-y focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
        </section>

        <!-- Save Button now calls saveDiaryEntry -->
        <button id="save-button" onclick="saveDiaryEntry()" class="w-full py-4 bg-gray-400 text-white font-bold text-lg rounded-xl transition-colors shadow-lg disabled:opacity-50" disabled>
            üîê Please Sign In to Save Entry
        </button>
        
        <!-- Log Output -->
        <section id="output-section" class="mt-6">
            <h2 class="text-xl text-gray-800 font-semibold border-b border-gray-200 pb-2 mb-4">üìù Generated Entry (Copy/Paste)</h2>
            <textarea id="diary-output" rows="15" readonly 
                      class="w-full p-4 bg-gray-100 border-2 border-dashed border-gray-400 rounded-lg text-sm font-mono-custom resize-y" 
                      placeholder="Your formatted entry will appear here after you click 'Generate & Copy Entry'."></textarea>
        </section>

    </main>

    <footer class="text-sm text-gray-500 mt-4 pb-8">
        <p>Built for the Life Map Logger &copy; 2025</p>
    </footer>

    <!-- JavaScript Logic & Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // NOTE: Added GoogleAuthProvider, signInWithPopup, signOut
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // Uncomment for detailed console logging

        // ----------------------------------------------------------------------------------
        // üî• PUBLIC CONFIGURATION REQUIRED FOR GITHUB PAGES (PLACE YOUR KEYS HERE) üî•
        // Replace these placeholder values with your actual Firebase Web App configuration keys.
        // You MUST replace YOUR_API_KEY_HERE and YOUR_PROJECT_ID with valid values.
        const PUBLIC_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID_HERE",
            appId: "APP_ID_HERE"
        };
        // ----------------------------------------------------------------------------------

        let db;
        let auth;
        let userId = null; // Changed to null, relies on successful Google sign-in
        
        // UI elements
        const statusMessageEl = document.getElementById('status-message');
        const authStatusDisplay = document.getElementById('auth-status-display');
        const authButton = document.getElementById('auth-button');
        const saveButton = document.getElementById('save-button');

        // Check if running in the secure Canvas environment
        const isRunningInCanvas = typeof __firebase_config !== 'undefined';
        
        let finalFirebaseConfig = null;
        let finalAppId = isRunningInCanvas ? (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id') : PUBLIC_FIREBASE_CONFIG.projectId;
        let initialAuthToken = isRunningInCanvas ? (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null) : null;
        
        if (isRunningInCanvas) {
            finalFirebaseConfig = JSON.parse(__firebase_config);
        } else if (PUBLIC_FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY_HERE") {
            finalFirebaseConfig = PUBLIC_FIREBASE_CONFIG;
        }

        /**
         * Updates the UI based on the user's authentication state.
         * @param {object | null} user - The authenticated Firebase user object or null.
         */
        function updateUserUI(user) {
            if (user) {
                const name = user.displayName || user.email;
                authStatusDisplay.textContent = `Signed in as: ${name}`;
                authButton.textContent = "Sign Out";
                authButton.onclick = signOutUser;
                saveButton.textContent = "üíæ Generate, Save & Copy Entry";
                saveButton.classList.remove('bg-gray-400');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-700');
                saveButton.disabled = false;
            } else {
                authStatusDisplay.textContent = "Please sign in to save data.";
                authButton.textContent = "Sign in with Google";
                authButton.onclick = signInWithGoogle;
                saveButton.textContent = "üîê Please Sign In to Save Entry";
                saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveButton.classList.add('bg-gray-400');
                saveButton.disabled = true;
            }
            authButton.disabled = false;
        }

        /**
         * Displays a status message to the user.
         */
        function setStatus(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.className = 'w-full max-w-3xl p-3 text-center text-sm font-semibold rounded-t-none';

            if (type === 'success') {
                statusMessageEl.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessageEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusMessageEl.classList.add('bg-yellow-100', 'text-yellow-800');
            }
            statusMessageEl.classList.remove('hidden');
        }

        /**
         * Initializes Firebase and sets up the authentication listener.
         */
        async function initializeFirebase() {
            if (!finalFirebaseConfig) {
                const localMessage = "‚ö†Ô∏è Storage Disabled: Firebase keys are missing. To save entries on GitHub Pages, please replace the placeholder config keys in the script.";
                setStatus(localMessage, 'error');
                console.error("Firebase Initialization Skipped:", localMessage);
                return;
            }
            
            try {
                const app = initializeApp(finalFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up the listener for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setStatus("Storage ready.", 'success');
                        updateUserUI(user);
                    } else {
                        userId = null;
                        setStatus("Ready for sign-in.", 'info');
                        updateUserUI(null);
                    }
                });

                // Only sign in with custom token in the secure canvas environment
                if (isRunningInCanvas && initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
                
                // FIX: If the listener hasn't fired yet, explicitly enable the button 
                // and set the status to prevent the "Authenticating..." hang.
                authButton.disabled = false;
                if (!auth.currentUser) {
                    authStatusDisplay.textContent = "Ready to sign in.";
                }

            } catch (error) {
                setStatus(`Initialization Failed: ${error.message}`, 'error');
                console.error("Firebase Init Error:", error);
                authButton.disabled = true;
                authStatusDisplay.textContent = "Authentication Failed.";
            }
        }

        /**
         * Authenticates the user using a Google pop-up window.
         */
        window.signInWithGoogle = async function() {
            try {
                setStatus("Opening Google sign-in window...", 'info');
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // Listener handles status update via onAuthStateChanged
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user') {
                    setStatus(`Sign-in Failed: ${error.message}`, 'error');
                    console.error("Google Sign-in Error:", error);
                } else {
                    setStatus("Sign-in cancelled.", 'info');
                }
            }
        }

        /**
         * Signs the current user out.
         */
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                setStatus("Successfully signed out.", 'success');
                // Listener handles UI update via onAuthStateChanged
            } catch (error) {
                setStatus(`Sign-out Failed: ${error.message}`, 'error');
                console.error("Sign-out Error:", error);
            }
        }

        // --- Counter Utility Functions ---
        window.changeCount = function(inputId, delta) {
            const input = document.getElementById(inputId);
            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + delta;
            
            if (newValue < 1) {
                newValue = 1;
            }
            
            input.value = newValue;
        }
        // --- END Counter Utility Functions ---

        // New utility function to calculate and update the weekday display
        window.updateWeekday = function() {
            const dateInput = document.getElementById('date-input');
            const weekdayDisplay = document.getElementById('weekday-display');
            const dateValue = dateInput.value; // Format: YYYY-MM-DD

            if (dateValue) {
                const date = new Date(dateValue.replace(/-/g, '/'));
                
                // Format YYYY/MM/DD
                const [year, month, day] = dateValue.split('-');
                const formattedDate = `${year}/${month}/${day}`;
                
                // Get the weekday
                const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });
                
                // Store the full formatted date string for easy retrieval
                const fullDateString = `${formattedDate}, ${weekday}`;
                dateInput.dataset.fullDate = fullDateString;

                weekdayDisplay.textContent = weekday;
            } else {
                weekdayDisplay.textContent = "";
                dateInput.dataset.fullDate = "";
            }
        }

        // Function to format the current date info and set input defaults
        function updateDateInfo() {
            const today = new Date();
            const isoDate = today.toISOString().substring(0, 10);
            
            // Set initial values for the inputs (pre-populating with suggested next counts)
            document.getElementById('date-input').value = isoDate;
            document.getElementById('consecutive-day-input').value = 32; 
            document.getElementById('accumulated-count-input').value = 55; 
            
            updateWeekday(); 
        }

        /**
         * Generates the log and saves the entry to Firestore.
         */
        window.saveDiaryEntry = async function() {
            if (!db || !userId) {
                setStatus("Error: Cannot save. Please ensure you are signed in.", 'error'); 
                return;
            }

            // 1. Collect all data
            const dateInput = document.getElementById('date-input');
            const data = {
                timestamp: new Date().toISOString(), // When the entry was recorded
                date: dateInput.value, // YYYY-MM-DD
                fullDateString: dateInput.dataset.fullDate, // YYYY/MM/DD, Weekday
                consecutiveDay: document.getElementById('consecutive-day-input').value.trim(),
                accumulatedCount: document.getElementById('accumulated-count-input').value.trim(),
                
                // Core Sections
                reflection: document.getElementById('reflection-entry').value.trim(),
                lifeMap: document.getElementById('life-map-log').value.trim(),
                work: document.getElementById('work-entry').value.trim(),
                
                // Goals & Practice
                weekGoals: document.getElementById('week-goals-entry').value.trim(),
                gamificationNotes: document.getElementById('gamification-notes-entry').value.trim(), 
                longTermPlan: document.getElementById('long-term-plan-entry').value.trim(),
                shortTermPlan: document.getElementById('short-term-plan-entry').value.trim(),
                englishPractice: document.getElementById('english-practice-entry').value.trim(),
                japanesePractice: document.getElementById('japanese-practice-entry').value.trim(),

                // Custom Notes
                customNotesTitle: document.getElementById('custom-notes-title').value.trim(),
                customNotes: document.getElementById('custom-notes-entry').value.trim(),
            };

            // 2. Format the entry for display (same as previous generateDiaryEntry logic)
            generateDiaryOutput(data);
            
            // 3. Save the entry to Firestore
            try {
                setStatus("Saving entry to cloud storage...", 'info');
                
                // Firestore path: /artifacts/{finalAppId}/users/{userId}/diary_entries
                const entriesRef = collection(db, `artifacts/${finalAppId}/users/${userId}/diary_entries`);
                
                await addDoc(entriesRef, data);
                
                setStatus(`Entry successfully saved! Date: ${data.fullDateString}.`, 'success');

            } catch (error) {
                setStatus(`Save Failed! Error: ${error.message}`, 'error');
                console.error("Firestore Save Error:", error);
            }
        }

        /**
         * Generates the formatted text output.
         */
        function generateDiaryOutput(data) {
            let output = '';

            // Date/Count Block (Always included)
            const dateLine = `Date: ${data.fullDateString}, Consecutive Day: ${data.consecutiveDay}, Accumulated Count: ${data.accumulatedCount}`;
            output += dateLine + '\n\n';
            
            // --- CONDITIONAL SECTIONS START HERE ---
            
            if (data.reflection.length > 0) {
                output += '# Story, Emotion, Gratitude, Reflection\n';
                output += data.reflection + '\n\n';
            }

            if (data.lifeMap.length > 0) {
                output += '# Life Map (Daily Architecture)\n';
                output += '## In this section, I want to write down the daily routine active. Those actives would be a habit.\n';
                output += '## These routine active should have a timer to follow. That\'s the concept of regular and discipline.\n';
                output += data.lifeMap + '\n\n';
            }

            if (data.work.length > 0) {
                output += '# work\n';
                output += data.work + '\n\n';
            }
            
            if (data.weekGoals.length > 0) {
                output += '# week goals (W44) & important plan\n'; 
                output += data.weekGoals + '\n\n';
            }

            if (data.gamificationNotes.length > 0) {
                output += '# Gamification Note\n'; 
                output += data.gamificationNotes + '\n\n';
            }

            if (data.longTermPlan.length > 0) {
                output += '# personal long term plan\n';
                output += data.longTermPlan + '\n\n';
            }

            if (data.shortTermPlan.length > 0) {
                output += '# personal short term plan\n';
                output += data.shortTermPlan + '\n\n';
            }

            if (data.englishPractice.length > 0) {
                output += '# English practice\n';
                output += data.englishPractice + '\n\n';
            }

            if (data.japanesePractice.length > 0) {
                output += '# Japanese practice\n';
                output += data.japanesePractice + '\n\n'; 
            }

            if (data.customNotes.length > 0) {
                output += `# ${data.customNotesTitle}\n`; 
                output += data.customNotes; 
            }
            
            output = output.trim();

            // 4. Output to the read-only text area
            const outputArea = document.getElementById('diary-output');
            outputArea.value = output;
            
            // 5. Attempt to automatically copy the text to the clipboard
            outputArea.select();
            outputArea.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
            } catch (err) {
                console.warn('Automatic copy failed.');
            }
        }

        // Initialize on load
        window.onload = function() {
            updateDateInfo();
            initializeFirebase();
        };
    </script>
</body>
</html>
